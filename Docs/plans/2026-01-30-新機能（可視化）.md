# 依存関係グラフビューア - 設計ドキュメント

**作成日**: 2026-01-30
**ステータス**: 設計完了、実装待ち

## 概要

CLAUDE.md、スキル、サブエージェント間の参照関係を1つのフォースレイアウトグラフで可視化し、設定全体の構造を把握しやすくする機能。

## 要件

### 可視化対象
- スキル間の呼び出し関係（`use superpowers:xxx`など）
- サブエージェント↔スキルの関係
- CLAUDE.md↔スキル/サブエージェントの参照
- 未分類の参照パターン（既知パターンに一致しないもの）

### ノードの種類（色分け）
| 種類 | 色 | 説明 |
|------|-----|------|
| CLAUDE.md | 🔵 青 | グローバル/プロジェクト設定 |
| スキル | 🟢 緑 | .mdスキルファイル |
| サブエージェント | 🟠 オレンジ | .mdサブエージェントファイル |
| 未分類 | 🟣 紫 | 不明な参照（?マーク付き） |

### エッジの種類（線種で区別）
| 種類 | 線種 | 説明 |
|------|------|------|
| 直接参照 | 実線 | `use superpowers:xxx`など |
| 言及 | 破線 | CLAUDE.md内での記述 |
| 壊れた参照 | 赤色破線 | 参照先が存在しない |

## UI設計

### 表示場所
メインエリアに専用タブ「📊 依存関係」として追加。エディタと同じ領域に表示。

### レイアウト構成
```
┌─────────────────────────────────────────┐
│ [タブ: ファイル名] [📊 依存関係]         │
├───────────────────────────┬─────────────┤
│                           │ 詳細パネル   │
│    グラフ表示エリア        │ ・ファイル名 │
│    （フォースレイアウト）   │ ・パス      │
│                           │ ・参照先    │
│                           │ ・参照元    │
├───────────────────────────┴─────────────┤
│ 凡例: 🔵CLAUDE.md 🟢スキル 🟠サブエージェント │
└─────────────────────────────────────────┘
```

### インタラクション
| 操作 | 動作 |
|------|------|
| マウスドラッグ | ノードを移動 |
| スクロール | ズームイン/アウト |
| シングルクリック | 詳細パネル更新 |
| ダブルクリック | エディタタブでファイルを開く |

## 技術実装

### 使用ライブラリ
- `react-force-graph-2d`: フォースレイアウトグラフ描画（約40KB gzip）

### 参照パターン検出（正規表現）
```typescript
const patterns = {
  // スキル呼び出し
  skillUse: /superpowers:([a-z-]+)/g,
  skillInvoke: /Skill tool.*["']([^"']+)["']/g,

  // サブエージェント参照
  subagentType: /subagent_type[=:]\s*["']?([A-Za-z-]+)/g,
  taskAgent: /Task.*agent.*["']([^"']+)["']/gi,

  // 未分類（参照っぽいパターン）
  unknown: /use\s+([a-z][a-z0-9-:]+)/gi
}
```

### 新規ファイル構成
```
src/
├── components/
│   └── graph/
│       ├── DependencyGraph.tsx    # メインコンポーネント
│       ├── GraphCanvas.tsx        # グラフ描画
│       └── NodeDetailPanel.tsx    # 詳細パネル
├── hooks/
│   └── useDependencyGraph.ts      # データ解析・状態管理
└── types/
    └── graph.ts                   # 型定義
```

## データフロー

### 初期化フロー
```
1. タブ選択「依存関係」
   ↓
2. useDependencyGraph フック起動
   ↓
3. ファイルツリーからスキル/サブエージェント一覧取得
   ↓
4. 各ファイルの内容を読み込み
   ↓
5. 正規表現で参照パターン抽出
   ↓
6. ノード・エッジデータ構築
   ↓
7. react-force-graph-2d でレンダリング
```

### 状態管理
```typescript
interface GraphState {
  nodes: GraphNode[];      // ノード配列（id, label, type, path）
  edges: GraphEdge[];      // エッジ配列（source, target, type）
  selectedNode: GraphNode | null;  // 選択中のノード
  isLoading: boolean;      // 読み込み中フラグ
}
```

### パフォーマンス考慮
- ファイル解析は初回のみ実行
- ファイル変更時は差分更新（変更されたファイルのみ再解析）
- 大量ノード対策: 100件超えたら警告＋フィルタ推奨

## エラーハンドリング

| ケース | 対応 |
|--------|------|
| ファイル読み込み失敗 | 該当ノードをグレー表示＋ツールチップで通知 |
| 参照先が存在しない | エッジを赤色破線で表示（壊れた参照） |
| 循環参照 | 検出して警告バッジ表示 |

## 未分類参照の扱い

- 既知パターンに一致しない参照 → 紫色ノードで「?」マーク付き表示
- 詳細パネルに「未分類の参照」セクションで一覧表示
- 新しい参照パターンが追加された場合も見落としを防ぐ

## 将来の拡張ポイント

- [ ] フィルタ機能（種類別、カテゴリ別で表示/非表示）
- [ ] 検索機能（特定ノードをハイライト）
- [ ] エクスポート（PNG/SVG画像出力）
- [ ] パターン設定のカスタマイズ（JSON設定ファイル）

## 実装手順

1. `react-force-graph-2d` をインストール
2. 型定義ファイル `src/types/graph.ts` を作成
3. フック `src/hooks/useDependencyGraph.ts` を実装
4. コンポーネント群 `src/components/graph/` を実装
5. タブバーに「依存関係」タブを追加
6. テスト・調整
